(this.webpackJsonparcgis=this.webpackJsonparcgis||[]).push([[183],{1179:function(e,t,i){"use strict";i.r(t);var r=i(2),n=i(5),a=i(6),s=i(7),l=i(0),o=i(22),d=i(35),u=i(1),c=(i(17),i(18),i(15)),h=i(10),v=i(13),_=i(99),y=i(20),g=i(23),x=i(4),b=i(9),f=i(93);function p(e){return Object(f.b)("esri/libs/vxl/".concat(e))}var w=i(243),m=c.a.getLogger(" esri.layers.VoxelWasmPerScene"),j=function(){function e(t){Object(r.a)(this,e),this._useDepthPass=!1,this._havePreparedWithAllLayers=!1,this._renderPluginContext=null,this._vxl=null,this._pluginIsActive=!1,this._moreToLoad=!1,this._viewportWidth=-1,this._viewportHeight=-1,this._newLayers=[],this._layers=new Map,this._renderPass=0,this._renderSlot=4,this._rctx=null,this._renderTargetToRestore=null,this._dbgFlags=new Set,this._dbgFlags.add(4),this._view=t,this.initialize()}return Object(n.a)(e,[{key:"canRender",get:function(){return!!this._vxl&&"local"===this._view.viewingMode}},{key:"dbg",value:function(e,t){this._dbgFlags.has(e)&&(4===e?m.error(t):m.warn(t))}},{key:"removeRenderPlugin",value:function(){this._pluginIsActive&&this._view._stage&&(this.dbg(1,"--removeRenderPlugin--"),this._view._stage.removeRenderPlugin(this)),this._pluginIsActive=!1}},{key:"initialize",value:function(){var e=this;this.dbg(1,"--initialize--"),this._readyWatchHandle=Object(d.a)(this._view,"ready",(function(t){t&&"local"===e._view.viewingMode?(e.dbg(1,"view ready status changed to ready on a local view, calling addRenderPlugin"),e._view._stage.addRenderPlugin([e._renderSlot],e),e._pluginIsActive=!0):(e.dbg(1,"view ready status changed, not ready or not a local view!"),e.removeRenderPlugin())})),this._qualityWatchHandle=Object(d.a)(this._view,"qualityProfile",(function(t){e.dbg(3,"qualityProfile changed to "+t),e._vxl&&e._vxl.set_quality(e.toWasmQuality(t))}))}},{key:"initializeRenderContext",value:function(e){this.dbg(1,"--initializeRenderContext--");var t=e.renderContext.rctx;"webgl2"===t.webglVersion?(this._renderPluginContext=e,this._rctx=e.renderContext.rctx,this.initializeWasm(t.gl)):this.dbg(4,"WebGL 1 context only!")}},{key:"uninitializeRenderContext",value:function(){this._renderPluginContext=null,this._rctx=null,this.dbg(1,"--uninitializeRenderContext--")}},{key:"restoreFramebuffer",value:function(){if(this._renderTargetToRestore){var e=this._renderTargetToRestore.fbo;if(this._rctx){this._rctx.bindFramebuffer(e,!0);var t=this._renderTargetToRestore.viewport;this._rctx.setViewport(t.x,t.y,t.width,t.height)}else this.dbg(4,"no context in restoreFramebuffer!")}}},{key:"bindPreviousDepthToSlot",value:function(e,t){var i=!!this._rctx,r=!!this._renderTargetToRestore;if(!i||!r)return 0;var n=this._renderTargetToRestore.fbo.depthStencilTexture;return n?(0===t?this._rctx.bindTexture(null,e,!0):this._rctx.bindTexture(n,e,!0),1):(this.dbg(4,"no depth/stencil texture exists!"),0)}},{key:"setBlendState",value:function(e,t,i,r){this._rctx?(this._rctx.setBlendingEnabled(1===e),this._rctx.setBlendFunction(t,i),this._rctx.setBlendEquation(r)):this.dbg(4,"setBlendState callback has no rendering context!")}},{key:"setFrontFace",value:function(e){this._rctx?this._rctx.setFrontFace(e):this.dbg(4,"setFrontFace callback has no rendering context!")}},{key:"setDepthStencilStateFunction",value:function(e,t,i){this._rctx?(this._rctx.setDepthFunction(i),this._rctx.setDepthTestEnabled(1===e),this._rctx.setDepthWriteEnabled(1===t),this._rctx.setStencilTestEnabled(!1),this._rctx.setStencilFunction(519,0,255),this._rctx.setStencilOpSeparate(1028,7680,7682,7680),this._rctx.setStencilOpSeparate(1029,7680,7683,7680)):this.dbg(4,"setDepthStencilStateFunction callback has no rendering context!")}},{key:"setRasterizerState",value:function(e){if(this._rctx)switch(e){case 1:this._rctx.setFaceCullingEnabled(!1);break;case 3:this._rctx.setCullFace(1029),this._rctx.setFaceCullingEnabled(!0);break;case 2:this._rctx.setCullFace(1028),this._rctx.setFaceCullingEnabled(!0)}else this.dbg(4,"setRasterizerState callback has no rendering context!")}},{key:"setViewport",value:function(e,t,i,r){this._rctx?this._rctx.setViewport(e,t,i,r):this.dbg(4,"setViewport callback has no rendering context!")}},{key:"syncRequestsResponses",value:function(){var e=this;this._layers.forEach((function(t,i){var r=[];t.responses.forEach((function(t,n){r.push(n),e.dbg(2,"responding for requestID:"+n+" size:"+t.size),e._vxl.respond(i,n,t)}));for(var n=t.responses,a=0,s=r;a<s.length;a++){var l=s[a];n.delete(l)}var o=e._vxl.get_new_requests(i),d=t.abortController.signal,u=function(i){t.outstandingRequestCount+=1,1===t.outstandingRequestCount&&t.layerView.updatingFlagChanged();var r=o[i],a={responseType:"array-buffer",signal:d};e.dbg(2,"making requestID:"+i+" url:"+r.url),Object(_.default)(r.url,a).then((function(a){t.outstandingRequestCount-=1,0===t.outstandingRequestCount&&t.layerView.updatingFlagChanged(),e.dbg(2,"have response for requestID:"+i);var s=0;if(a.data.byteLength>0){s=e._vxl._malloc(a.data.byteLength);for(var l=new Uint8Array(e._vxl.HEAPU8.buffer,s,a.data.byteLength),o=new Uint8Array(a.data),d=0;d<a.data.byteLength;++d)l[d]=o[d]}n.set(+i,{type:r.type,ptr:s,size:a.data.byteLength,success:!0})})).catch((function(a){t.outstandingRequestCount-=1,0===t.outstandingRequestCount&&t.layerView.updatingFlagChanged(),Object(g.n)(a)||(e.dbg(4,"requestID:"+i+" failed"),n.set(+i,{type:r.type,ptr:0,size:0,success:!1}))}))};for(var c in o)u(c)}))}},{key:"updateWasmCamera",value:function(e){this._vxl.set_projection_matrix.apply(this._vxl,e.projectionMatrix),this._vxl.set_view_matrix.apply(this._vxl,e.viewMatrix),this._vxl.set_near_far(e.near,e.far)}},{key:"isUpdating",value:function(e){return!(this._vxl||!this._vxlPromise)||!!this._layers.has(e)&&this._layers.get(e).outstandingRequestCount>0}},{key:"setEnabled",value:function(e,t){var i=this;this._layers.forEach((function(r,n){r.layerView===e&&(i._vxl.set_enabled(n,t?1:0),i._renderPluginContext.requestRender())}))}},{key:"addVoxelLayer",value:function(e){if(!this._vxl){var t={layerView:e,resolveCallback:"",rejectCallback:""},i=new Promise((function(e,i){t.resolveCallback=e,t.rejectCallback=i}));return this._newLayers.push(t),i}var r=this._addVoxelLayer(e);return r<0?Promise.reject(-1):Promise.resolve(r)}},{key:"removeVoxelLayer",value:function(e){var t=this;if(!this._vxl){var i=this._newLayers.findIndex((function(t){return e===t.layerView}));i>=0&&(this._newLayers[i].resolveCallback(-1),this._newLayers.splice(i,1));var r=this._newLayers.length;return 0===r&&(this.dbg(1," no voxel layers left after removing a layer, removing RenderPlugin and destroying"),this.destroy()),r}var n=-1;this._layers.forEach((function(i,r){i.layerView===e&&(n=r,i.abortController.abort(),t._vxl.remove_layer(n))})),n>=0&&this._layers.delete(n);var a=this._layers.size;return 0===a&&(this.dbg(1," no voxel layers left after removing a layer, removing RenderPlugin and destroying"),this.destroy()),a}},{key:"_addVoxelLayer",value:function(e){var t=e.layer,i=-1,r=t.layerData;if(r&&r.data.byteLength>0){for(var n=this._vxl._malloc(r.data.byteLength),a=new Uint8Array(this._vxl.HEAPU8.buffer,n,r.data.byteLength),s=new Uint8Array(r.data),l=0;l<r.data.byteLength;++l)a[l]=s[l];var o=32662===this._view.spatialReference.wkid&&t.spatialReference.isWGS84?111319.49079327357:1;i=this._vxl.add_layer(t.serviceRoot,n,r.data.byteLength,o,o),this._vxl._free(n)}if(i>=0){var d=Object(g.e)();return this._layers.set(i,{layerView:e,responses:new Map,outstandingRequestCount:0,abortController:d}),i}return-1}},{key:"prepareRender",value:function(e){if(this._vxl){var t=e.viewForward,i=e.eye;this._vxl.update_camera_pos_and_direction(i[0],i[1],i[2],t[0],t[1],t[2]);var r=this._vxl.cull();this.dbg(2,"missingResourceCount="+r),this._moreToLoad=r>0,this._havePreparedWithAllLayers=0===this._newLayers.length}}},{key:"render",value:function(e){if(!this._vxl)return!1;var t,i=Object(v.a)(this._newLayers);try{for(i.s();!(t=i.n()).done;){var r=t.value,n=this._addVoxelLayer(r.layerView);-1===n?r.rejectCallback(-1):r.resolveCallback(n)}}catch(s){i.e(s)}finally{i.f()}if(this._newLayers=[],e.pass!==this._renderPass)return!1;if(e.slot!==this._renderSlot)return!1;if(0===this._layers.size)return this.dbg(4,"No voxel layers but RenderPlugin instance is being asked to render!"),!0;this._renderTargetToRestore={fbo:this._rctx.getBoundFramebufferObject(),viewport:this._rctx.getViewport()},this.syncRequestsResponses(),this._vxl.begin_frame();var a=this._renderTargetToRestore.viewport;return a.width===this._viewportWidth&&a.height===this._viewportHeight||(this._viewportWidth=a.width,this._viewportHeight=a.height,this._vxl.set_viewport(a.width,a.height)),0===a.x&&0===a.y||this.dbg(4,"Unsupported viewport parameters detected!"),this.updateWasmCamera(e.camera),this._vxl.draw(),this._renderTargetToRestore.fbo=null,e.rctx.externalTextureUnitUpdate(this._vxl.get_texture_units_bound_in_frame(),this._vxl.get_active_texture_unit()),e.rctx.externalVertexArrayObjectUpdate(),e.rctx.externalVertexBufferUpdate(),(this._moreToLoad||!this._havePreparedWithAllLayers&&this._layers.size>0)&&this._renderPluginContext.requestRender(),!0}},{key:"queryDepthRange",value:function(e){this.dbg(1,"--queryDepthRange--");var t=e.viewForward,i=e.eye;this._vxl.update_camera_pos_and_direction(i[0],i[1],i[2],t[0],t[1],t[2]),this._vxl.cull();var r={near:5,far:1e4};return r.near=this._vxl.get_near(),r.far=this._vxl.get_far(),r}},{key:"destroy",value:function(){this.dbg(1,"--destroy--"),this.removeRenderPlugin(),this._readyWatchHandle&&(this._readyWatchHandle.remove(),this._readyWatchHandle=null),this._qualityWatchHandle&&(this._qualityWatchHandle.remove(),this._qualityWatchHandle=null),this._vxl&&(this._vxl.uninitialize_voxel_wasm(),this._vxl=null)}},{key:"initializeWasm",value:function(e){var t=this;return this._vxl?Promise.resolve():(this._vxlPromise||(this._vxlPromise=function(e){return new Promise((function(t){return i.e(153).then(i.bind(null,1161)).then((function(e){return e.v})).then((function(i){var r=(0,i.default)({locateFile:p,preinitializedWebGLContext:e,onRuntimeInitialized:function(){return t(r)}})}))})).catch((function(e){return Promise.reject(e)}))}(e).then((function(e){if(t._vxl=e,t._vxlPromise=null,t._newLayers.length<=0)return t.dbg(1," no voxel layers left after WASM downloaded, removing RenderPlugin and destroying"),void t.destroy();var i=t._vxl.addFunction(t.restoreFramebuffer.bind(t),"v"),r=t._vxl.addFunction(t.setBlendState.bind(t),"viiii"),n=t._vxl.addFunction(t.setFrontFace.bind(t),"vi"),a=t._vxl.addFunction(t.setRasterizerState.bind(t),"vi"),s=t._vxl.addFunction(t.setDepthStencilStateFunction.bind(t),"viii"),l=t._vxl.addFunction(t.setViewport.bind(t),"viiii"),o=t._vxl.addFunction(t.bindPreviousDepthToSlot.bind(t),"iii");t._vxl.initialize_voxel_wasm(i,r,n,a,s,l,o),t._vxl.set_quality(t.toWasmQuality(t._view.qualityProfile)),t._renderPluginContext&&t._renderPluginContext.requestRender()})).catch((function(){var e,i=Object(v.a)(t._newLayers);try{for(i.s();!(e=i.n()).done;){e.value.rejectCallback(-2)}}catch(r){i.e(r)}finally{i.f()}t.dbg(4," WASM failed to download, removing RenderPlugin and destroying"),t.destroy()}))),this._vxlPromise)}},{key:"type",get:function(){return"external"}},{key:"isGround",get:function(){return!1}},{key:"slicePlane",get:function(){return!1}},{key:"intersectionHandlerId",get:function(){return"unj"}},{key:"intersect",value:function(e,t,i,r,n){if(this._vxl&&this._rctx&&0!==this._layers.size&&!(n[0]<0||n[0]>e.camera.viewport[2]||n[1]<0||n[1]>e.camera.viewport[3])){this._renderTargetToRestore={fbo:this._rctx.getBoundFramebufferObject(),viewport:this._rctx.getViewport()};var a=e.camera.viewForward,s=e.camera.eye;this._vxl.update_camera_pos_and_direction(s[0],s[1],s[2],a[0],a[1],a[2]),this.updateWasmCamera(e.camera),this._vxl.begin_frame(),this._useDepthPass?this.intersectDepth(e,t,i,r,n):this.intersectObject(e,t,i,r,n),this._renderTargetToRestore.fbo=null,this._rctx.externalTextureUnitUpdate(this._vxl.get_texture_units_bound_in_frame(),this._vxl.get_active_texture_unit()),this._rctx.externalVertexArrayObjectUpdate(),this._rctx.externalVertexBufferUpdate()}}},{key:"intersectObject",value:function(e,t,i,r,n){var a=this,s=this._vxl.pick_object(n[0],n[1]);if(s.success){var l=Object(b.e)();Object(x.C)(l,r,i),Object(x.t)(l,l);var o=Object(x.o)(i,r),d=Object(b.e)();Object(x.y)(d,s.worldX,s.worldY,s.worldZ);var u=Object(b.e)();Object(x.C)(u,d,i);var c=Object(b.e)();Object(x.g)(c,l,Object(x.j)(u,l));var h=Object(b.e)();Object(x.h)(h,i,c);var v=Object(x.o)(i,h),_=Object(y.e)(v/o,0,1),g=function(e){e.intersector="Voxel",e.dist=_,e.target={type:"external",metadata:{layerUid:a.intersectionHandlerId}}},f=e.results.min;(null==f.dist||_<f.dist)&&(null==t||t(i,r,_))&&g(f);var p=e.results.max;if(0!==e.options.store&&(null==p.dist||_>p.dist)&&(null==t||t(i,r,_))&&g(p),2===e.options.store){var m=new w.a(e.ray);g(m),e.results.all.push(m)}}}},{key:"intersectDepth",value:function(e,t,i,r,n){var a=this,s=this._vxl.pick_depth(n[0],n[1]);if(s.success){var l=Object(b.e)();Object(x.C)(l,r,i),Object(x.t)(l,l);var o=Object(x.o)(i,r),d=Object(b.e)();Object(x.y)(d,s.worldX,s.worldY,s.worldZ);var u=Object(b.e)();Object(x.C)(u,d,i);var c=Object(b.e)();Object(x.g)(c,l,Object(x.j)(u,l));var h=Object(b.e)();Object(x.h)(h,i,c);var v=Object(x.o)(i,h),_=Object(y.e)(v/o,0,1),g=function(e){e.intersector="Voxel",e.dist=_,e.target={type:"external",metadata:{layerUid:a.intersectionHandlerId}}},f=e.results.min;(null==f.dist||_<f.dist)&&(null==t||t(i,r,_))&&g(f);var p=e.results.max;if(0!==e.options.store&&(null==p.dist||_>p.dist)&&(null==t||t(i,r,_))&&g(p),2===e.options.store){var m=new w.a(e.ray);g(m),e.results.all.push(m)}}}},{key:"toWasmQuality",value:function(e){switch(e){case"low":return 0;case"medium":return 1;case"high":return 2}}}]),e}(),k=function(){function e(){Object(r.a)(this,e),this.view2WASM=new Map}return Object(n.a)(e,[{key:"isUpdating",value:function(e,t){return!!this.view2WASM.has(e)&&this.view2WASM.get(e).isUpdating(t)}},{key:"addLayer",value:function(e,t){return this.view2WASM.has(e)||this.view2WASM.set(e,new j(e)),this.view2WASM.get(e).addVoxelLayer(t)}},{key:"removeLayer",value:function(e,t){this.view2WASM.has(e)&&this.view2WASM.get(e).removeVoxelLayer(t)<1&&this.view2WASM.delete(e)}},{key:"setLayerEnabled",value:function(e,t,i){this.view2WASM.has(e)&&this.view2WASM.get(e).setEnabled(t,i)}}],[{key:"getInstance",value:function(){return e.instance||(e.instance=new e),e.instance}}]),e}(),O=i(572),R=i(571),L=function(e){Object(a.a)(i,e);var t=Object(s.a)(i);function i(){var e;return Object(r.a)(this,i),(e=t.apply(this,arguments)).type="voxel-3d",e._wasmLayerId=-1,e}return Object(n.a)(i,[{key:"initialize",value:function(){var e=this;if("local"!==this.view.viewingMode)throw new o.a("voxel:unsupported-viewingMode","Voxel layers support local viewingMode only.",{});if("webgl"===this.view.renderContext)throw new o.a("voxel:unsupported-context","Voxel layers are supported in WebGL2 rendering contexts only.",{});var t=k.getInstance(),i=t.addLayer(this.view,this).then((function(t){e._wasmLayerId=t,e._suspendedHandle=Object(d.a)(e,"suspended",(function(t){k.getInstance().setLayerEnabled(e.view,e,!t)}))})).catch((function(i){if(t.removeLayer(e.view,e),e._wasmLayerId=-1,-1===i)throw new o.a("voxel:addLayer-failure","The voxel layer description was invalid.",{});if(-2===i)throw new o.a("voxel:addLayer-failure","The voxel layer web assembly module failed to download.",{})}));this.addResolvingPromise(i)}},{key:"destroy",value:function(){k.getInstance().removeLayer(this.view,this),this._suspendedHandle&&(this._suspendedHandle.remove(),this._suspendedHandle=null)}},{key:"isUpdating",value:function(){return!(this._wasmLayerId<0)&&k.getInstance().isUpdating(this.view,this._wasmLayerId)}},{key:"updatingFlagChanged",value:function(){this.notifyChange("updating")}}]),i}(Object(O.a)(R.a));Object(l.a)([Object(u.b)()],L.prototype,"layer",void 0),Object(l.a)([Object(u.b)({readOnly:!0,aliasOf:"layer.parsedUrl.path"})],L.prototype,"baseUrl",void 0);var C=L=Object(l.a)([Object(h.a)("esri.views.3d.layers.VoxelLayerView3D")],L);t.default=C}}]);
//# sourceMappingURL=183.70d497e7.chunk.js.map