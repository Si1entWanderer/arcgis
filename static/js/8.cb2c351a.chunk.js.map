{"version":3,"sources":["../node_modules/@arcgis/core/views/3d/layers/support/projectExtentUtils.js","../node_modules/@arcgis/core/chunks/ImageMaterial.glsl.js","../node_modules/@arcgis/core/views/3d/layers/support/overlayImageUtils.js","../node_modules/@arcgis/core/views/3d/layers/DynamicLayerView3D.js","../node_modules/@arcgis/core/views/3d/webgl-engine/shaders/ImageMaterialTechnique.js","../node_modules/@arcgis/core/views/3d/webgl-engine/materials/ImageMaterial.js"],"names":["t","l","view","spatialReference","s","layer","fullExtent","i","equals","Promise","resolve","clone","e","r","state","isLocal","o","portalItem","then","destroyed","catch","n","include","linearDepth","vertex","uniforms","add","attributes","varyings","multipassTerrainEnabled","code","fragment","a","output","float","d","OITEnabled","Object","freeze","__proto__","build","createSquareGeometry","h","Math","min","max","u","m","c","g","Float64Array","w","Float32Array","Uint32Array","f","p","y","x","M","v","length","size","data","exclusive","H","getLogger","O","arguments","drapeSourceType","updatePolicy","fullExtentInLocalViewSpatialReference","maximumDataResolution","_images","Array","_extents","_overlayExtents","updateWhenStationary","this","addResolvingPromise","L","_set","updatingHandles","_suspendedChangeHandler","handles","resourceController","scheduler","registerIdleStateCallbacks","_isScaleRangeActive","notifyChange","_isScaleRangeLayer","viewingMode","basemapTerrain","forEach","_updateImageExtent","clear","index","extent","resolution","renderLocalOrigin","pixelRatio","_clippedExtent","P","width","height","round","E","imageMaxWidth","imageMaxHeight","floor","_imageSizeDiffers","imageSize","suspended","_fetch","error","_clearImage","push","minScale","maxScale","scale","some","loadingPromise","HTMLImageElement","HTMLCanvasElement","image","contains","_createStageObjects","A","TESTS_DISABLE_UPDATE_THRESHOLDS","_","abs","texture","material","renderGeometry","loadingAbortController","pixelData","renderExtent","abort","signal","_waitFetchReady","requestAsImageElement","getFetchOptions","timestamp","refreshTimestamp","fetchImage","warnOnce","processResult","R","overlayManager","renderer","removeGeometries","_stage","remove","D","preMultiplyAlpha","wrap","j","I","transparent","textureId","id","setParameterValues","C","origin","addGeometries","ready","b","refresh","T","S","G","prototype","readOnly","V","shader","get","configuration","slicePlaneEnabled","sliceHighlightDisabled","sliceEnabledForVertexPrograms","transparencyPassType","cullAboveGround","rctx","program","camera","projectionMatrix","setUniform1f","opacity","setUniform2fv","nearFar","inverseViewport","rebindTextures","blending","culling","cullFace","depthTest","func","depthWrite","writeDepth","colorWrite","stencilWrite","sceneHasOcludees","stencilTest","polygonOffset","enableOffset","_occludeePipelineState","setPipelineState","pipeline","count","supportsEdges","techniqueConfig","params","relativeElevation","updateParameters","_material","updateTexture","_technique","_techniqueRep","releaseAndAcquire","getTechniqueConfig","_output","hasOccludees","_updateOccludeeState","bindTextures","bindTextureScale","bindPass","getPipelineState","initTextureTransparent"],"mappings":"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","file":"static/js/8.cb2c351a.chunk.js","sourcesContent":["/*\nAll material copyright ESRI, All Rights Reserved, unless otherwise specified.\nSee https://js.arcgis.com/4.20/esri/copyright.txt for details.\n*/\nimport{canProject as e,project as r}from\"../../../../geometry/support/webMercatorUtils.js\";import{projectGeometry as o}from\"../../../../portal/support/geometryServiceUtils.js\";function t(t){const l=t.view.spatialReference,s=t.layer.fullExtent,i=s&&s.spatialReference;return i?i.equals(l)?Promise.resolve(s.clone()):e(i,l)?Promise.resolve(r(s,l)):t.view.state.isLocal?o(s,l,t.layer.portalItem).then((e=>!t.destroyed&&e?e:void 0)).catch((()=>null)):Promise.resolve(null):Promise.resolve(null)}export{t as toViewIfLocal};\n","/*\nAll material copyright ESRI, All Rights Reserved, unless otherwise specified.\nSee https://js.arcgis.com/4.20/esri/copyright.txt for details.\n*/\nimport{Slice as e}from\"../views/3d/webgl-engine/core/shaderLibrary/Slice.glsl.js\";import{Transform as r}from\"../views/3d/webgl-engine/core/shaderLibrary/Transform.glsl.js\";import{ReadLinearDepth as a}from\"../views/3d/webgl-engine/core/shaderLibrary/output/ReadLinearDepth.glsl.js\";import{multipassTerrainTest as o}from\"../views/3d/webgl-engine/core/shaderLibrary/shading/MultipassTerrainTest.glsl.js\";import{defaultMaskAlphaCutoff as i}from\"../views/3d/webgl-engine/core/shaderLibrary/util/AlphaDiscard.glsl.js\";import{ColorConversion as d}from\"../views/3d/webgl-engine/core/shaderLibrary/util/ColorConversion.glsl.js\";import{glsl as t}from\"../views/3d/webgl-engine/core/shaderModules/interfaces.js\";import{ShaderBuilder as l}from\"../views/3d/webgl-engine/core/shaderModules/ShaderBuilder.js\";function s(s){const n=new l;return n.include(r,{linearDepth:!1}),n.vertex.uniforms.add(\"proj\",\"mat4\").add(\"view\",\"mat4\"),n.attributes.add(\"position\",\"vec3\"),n.attributes.add(\"uv0\",\"vec2\"),n.varyings.add(\"vpos\",\"vec3\"),s.multipassTerrainEnabled&&n.varyings.add(\"depth\",\"float\"),n.vertex.uniforms.add(\"textureCoordinateScaleFactor\",\"vec2\"),n.vertex.code.add(t`\n    void main(void) {\n      vpos = position;\n      ${s.multipassTerrainEnabled?\"depth = (view * vec4(vpos, 1.0)).z;\":\"\"}\n      vTexCoord = uv0 * textureCoordinateScaleFactor;\n      gl_Position = transformPosition(proj, view, vpos);\n    }\n  `),n.include(e,s),s.multipassTerrainEnabled&&(n.fragment.include(a),n.include(o,s)),n.fragment.uniforms.add(\"tex\",\"sampler2D\"),n.fragment.uniforms.add(\"opacity\",\"float\"),n.varyings.add(\"vTexCoord\",\"vec2\"),7===s.output?n.fragment.code.add(t`\n    void main() {\n      discardBySlice(vpos);\n      ${s.multipassTerrainEnabled?\"terrainDepthTest(gl_FragCoord, depth);\":\"\"}\n\n      float alpha = texture2D(tex, vTexCoord).a * opacity;\n      if (alpha  < ${t.float(i)}) {\n        discard;\n      }\n\n      gl_FragColor = vec4(alpha);\n    }\n    `):(n.fragment.include(d),n.fragment.code.add(t`\n    void main() {\n      discardBySlice(vpos);\n      ${s.multipassTerrainEnabled?\"terrainDepthTest(gl_FragCoord, depth);\":\"\"}\n      gl_FragColor = texture2D(tex, vTexCoord) * opacity;\n\n      if (gl_FragColor.a < ${t.float(i)}) {\n        discard;\n      }\n\n      gl_FragColor = highlightSlice(gl_FragColor, vpos);\n      ${s.OITEnabled?\"gl_FragColor = premultiplyAlpha(gl_FragColor);\":\"\"}\n    }\n    `)),n}var n=Object.freeze({__proto__:null,build:s});export{n as I,s as b};\n","/*\nAll material copyright ESRI, All Rights Reserved, unless otherwise specified.\nSee https://js.arcgis.com/4.20/esri/copyright.txt for details.\n*/\nimport{width as t,height as e,intersects as n}from\"../../../../geometry/support/aaBoundingRect.js\";import{Geometry as i}from\"../../webgl-engine/lib/Geometry.js\";import r from\"../../webgl-engine/lib/GeometryUtil.js\";function o(n,i,r){const o=t(n)/e(n),a={width:r,height:r};return o>1.0001?a.height=r/o:o<.9999&&(a.width=r*o),a.width=Math.round(a.width/(t(n)/t(i))),a.height=Math.round(a.height/(e(n)/e(i))),a}function a(t){return r.createSquareGeometry([[t[0],t[1],-1],[t[2],t[1],-1],[t[2],t[3],-1],[t[0],t[3],-1]])}function h(t,e){if(!n(t,e))return a(e);const r=[t[1]-e[1],Math.min(t[3],e[3])-Math.max(t[1],e[1]),e[3]-t[3],123456],o=[t[0]-e[0],Math.min(t[2],e[2])-Math.max(t[0],e[0]),e[2]-t[2],123456],h=e[2]-e[0],u=e[3]-e[1],l=o[0]>0&&o[2]>0?3:2,m=r[0]>0&&r[2]>0?3:2,c=(m+1)*(l+1),g=new Float64Array(3*c),w=new Float32Array(2*c),d=new Uint32Array(6*(m*l-1));let f=0,p=0,y=0,x=0,M=0;for(let n=0;n<4;n++){const t=r[n];if(t<=0)continue;let i=0;for(let r=0;r<4;r++){const t=o[r];t<=0||(g[p++]=e[0]+i,g[p++]=e[1]+f,g[p++]=-1,w[y++]=i/h,w[y++]=f/u,r<3&&n<3&&(1!==r||1!==n)&&(d[M++]=x,d[M++]=x+1,d[M++]=x+l+1,d[M++]=x+1,d[M++]=x+l+2,d[M++]=x+l+1),x++,i+=t)}f+=t}const v=new Uint32Array(d.length);return new i([[\"position\",{size:3,data:g,exclusive:!0}],[\"normal\",{size:3,data:s,exclusive:!0}],[\"uv0\",{size:2,data:w,exclusive:!0}]],[[\"position\",d],[\"normal\",v],[\"uv0\",d]])}const s=[0,0,1];export{o as computeImageExportSize,a as createGeometryForExtent,h as createOuterImageGeometry};\n","/*\nAll material copyright ESRI, All Rights Reserved, unless otherwise specified.\nSee https://js.arcgis.com/4.20/esri/copyright.txt for details.\n*/\nimport{_ as e}from\"../../../chunks/tslib.es6.js\";import{forEach as t,result as i}from\"../../../core/asyncUtils.js\";import r from\"../../../core/Logger.js\";import{isSome as a,isNone as s}from\"../../../core/maybe.js\";import{isAbortError as n,eachAlways as o,createAbortController as l,onAbort as h,isAborted as m,createAbortError as d,always as c,throwIfAborted as g}from\"../../../core/promiseUtils.js\";import{whenOnce as u}from\"../../../core/watchUtils.js\";import{property as p}from\"../../../core/accessorSupport/decorators/property.js\";import\"../../../core/has.js\";import\"../../../core/accessorSupport/ensureType.js\";import{subclass as y}from\"../../../core/accessorSupport/decorators/subclass.js\";import f from\"../../../geometry/Extent.js\";import{create as x,equals as w,width as _,height as v,set as R,intersection as b}from\"../../../geometry/support/aaBoundingRect.js\";import{LayerView3D as S}from\"./LayerView3D.js\";import{computeImageExportSize as E,createGeometryForExtent as j,createOuterImageGeometry as I}from\"./support/overlayImageUtils.js\";import{toViewIfLocal as L}from\"./support/projectExtentUtils.js\";import A from\"../support/debugFlags.js\";import{RenderGeometry as C}from\"../webgl-engine/lib/RenderGeometry.js\";import{Texture as D}from\"../webgl-engine/lib/Texture.js\";import{ImageMaterial as M}from\"../webgl-engine/materials/ImageMaterial.js\";import G from\"../../layers/LayerView.js\";import{RefreshableLayerView as T}from\"../../layers/RefreshableLayerView.js\";const H=r.getLogger(\"esri.views.3d.layers.DynamicLayerView3D\");let O=class extends(T(S(G))){constructor(){super(...arguments),this.drapeSourceType=0,this.updatePolicy=1,this.fullExtentInLocalViewSpatialReference=null,this.maximumDataResolution=null,this._images=new Array,this._extents=new Array,this._overlayExtents=new Array,this.updateWhenStationary=!0}initialize(){this.addResolvingPromise(L(this).then((e=>this._set(\"fullExtentInLocalViewSpatialReference\",e)))),this.updatingHandles.add(this,\"suspended\",(()=>this._suspendedChangeHandler())),this.handles.add(this.view.resourceController.scheduler.registerIdleStateCallbacks((()=>{this._isScaleRangeActive()&&this.notifyChange(\"suspended\")}),(()=>{}))),this._isScaleRangeLayer()&&this.updatingHandles.add(this.layer,\"scaleRangeId\",(()=>this.notifyChange(\"suspended\"))),\"local\"===this.view.viewingMode&&this.updatingHandles.add(this.view.basemapTerrain,\"extent\",(()=>this._overlayExtents.forEach(((e,t)=>this._updateImageExtent(t)))))}destroy(){this.clear()}setDrapingExtent(e,t){this._overlayExtents[e.index]={extent:x(e.extent),spatialReference:t,resolution:e.resolution,renderLocalOrigin:e.renderLocalOrigin,pixelRatio:e.pixelRatio},this._updateImageExtent(e.index)}_updateImageExtent(e){const t=this._overlayExtents[e],i=this._clippedExtent(t.extent,P),r=E(t.extent,i,t.resolution);let a=t.pixelRatio*this.view.pixelRatio;if(\"imageMaxWidth\"in this.layer||\"imageMaxHeight\"in this.layer){const e=this.layer.imageMaxWidth,t=this.layer.imageMaxHeight;if(r.width>e){const t=e/r.width;r.height=Math.floor(r.height*t),r.width=e,a*=t}if(r.height>t){const e=t/r.height;r.width=Math.floor(r.width*e),r.height=t,a*=e}}const s=this._extents[e];s&&w(s.extent,i)&&!this._imageSizeDiffers(i,s.imageSize,r)||(this._extents[e]={extent:x(i),spatialReference:t.spatialReference,imageSize:r,pixelRatio:a},this.suspended||this._fetch(e).catch((e=>{n(e)||H.error(e)})))}clear(){for(let e=0;e<this._images.length;e++)this._clearImage(e)}async doRefresh(e){if(this.suspended)return;const t=[];for(let i=0;i<this._extents.length;i++)this._extents[i]&&t.push(this._fetch(i,e));await o(t)}canResume(){if(!super.canResume())return!1;if(this._isScaleRangeLayer()){const{minScale:e,maxScale:t}=this.layer;if(e>0||t>0){const i=this.view.scale;if(i<t||e>0&&i>e)return!1}}return!0}isUpdating(){return this._images.some((e=>!!e.loadingPromise))}async processResult(e,t,i){(t instanceof HTMLImageElement||t instanceof HTMLCanvasElement)&&(e.image=t)}findExtentInfoAt(e){for(const t of this._extents){const i=t.extent;if(new f(i[0],i[1],i[2],i[3],t.spatialReference).contains(e))return t}return null}getFetchOptions(){}async redraw(e,i){await t(this._images,(async(t,r)=>{t&&(await e(t,i),await this._createStageObjects(r,t.image))}))}_imageSizeDiffers(e,t,i){if(!this.maximumDataResolution||A.TESTS_DISABLE_UPDATE_THRESHOLDS)return!0;const r=_(e)/this.maximumDataResolution.x,a=v(e)/this.maximumDataResolution.y,s=r/t.width,n=a/t.height,o=r/i.width,l=a/i.height,h=Math.abs(s-o),m=Math.abs(n-l);return h>1.5||m>1.5}async _fetch(e,t){if(this.suspended)return;const i=this._extents[e],r=i.extent;this._images[e]||(this._images[e]={texture:null,material:null,renderGeometry:null,loadingPromise:null,loadingAbortController:null,image:null,pixelData:null,renderExtent:x(r)});const a=this._images[e];a.loadingAbortController&&(a.loadingAbortController.abort(),a.loadingAbortController=null);const s=new f(r[0],r[1],r[2],r[3],i.spatialReference);if(0===s.width||0===s.height)return void this._clearImage(e);const o=l();a.loadingAbortController=o,h(t,(()=>o.abort()));const g=o.signal,u=this._waitFetchReady(g).then((()=>{const t={requestAsImageElement:!0,pixelRatio:this._overlayExtents[e].pixelRatio,...this.getFetchOptions(),signal:g},{height:r,width:a}=i.imageSize;return t.timestamp=this.refreshTimestamp,this.layer.fetchImage(s,a,r,t)})).then((e=>{if(m(g))throw H.warnOnce(\"A call to fetchImage resolved even though the request was aborted. fetchImage should not resolve if options.signal.aborted is true.\"),d();return this.processResult(a,e)})).then((()=>R(a.renderExtent,r)));a.loadingPromise=u,c(u,(()=>{u===a.loadingPromise&&(a.loadingPromise=null,a.loadingAbortController=null)}));const p=u.then((async()=>{await this._createStageObjects(e,a.image),this.notifyChange(\"updating\")})).catch((e=>{throw e&&!n(e)&&H.error(e),this.notifyChange(\"updating\"),e}));this.notifyChange(\"updating\"),await p}_clearImage(e){const t=this._images[e];if(t){a(t.renderGeometry)&&(this.view.basemapTerrain.overlayManager.renderer.removeGeometries([t.renderGeometry],this,2),t.renderGeometry=null);const e=this.view._stage;e.remove(t.texture),t.texture=null,e.remove(t.material),t.material=null,t.loadingAbortController&&(t.loadingAbortController.abort(),t.loadingAbortController=null),t.loadingPromise=null,t.image=null,t.pixelData=null}}async _createStageObjects(e,t){const r=this.view._stage,n=this._images[e],o=this.view.basemapTerrain.overlayManager.renderer,l=()=>{r.remove(n.texture),n.texture=null,a(n.renderGeometry)&&(o.removeGeometries([n.renderGeometry],this,2),n.renderGeometry=null)};if(t){const a=new D(t,{width:t.width,height:t.height,preMultiplyAlpha:!0,wrap:{s:33071,t:33071}});let h;if(await i(this._images[0===e?1:0].loadingPromise),0===e)h=j(n.renderExtent);else{const e=this._images[0].renderExtent;if(!e)return void l();h=I(e,n.renderExtent)}l(),r.add(a),n.texture=a,s(n.material)?(n.material=new M({transparent:!0,textureId:a.id}),r.add(n.material)):n.material.setParameterValues({textureId:a.id}),n.renderGeometry=new C(h,n.material),n.renderGeometry.origin=this._overlayExtents[e].renderLocalOrigin,o.addGeometries([n.renderGeometry],this,2)}else l(),r.remove(n.material),n.material=null}_isScaleRangeLayer(){return\"minScale\"in this.layer&&\"maxScale\"in this.layer}_isScaleRangeActive(){return!!this._isScaleRangeLayer()&&(this.layer.minScale>0||this.layer.maxScale>0)}_clippedExtent(e,t){if(\"local\"!==this.view.viewingMode)return R(t,e);const i=this.view.basemapTerrain,r=i.extent;return i.ready&&r?b(e,r,t):R(t,e)}_suspendedChangeHandler(){this.suspended?this.clear():this.refresh()}async _waitFetchReady(e){await u(this.view,\"stationary\",e),g(e)}};e([p()],O.prototype,\"layer\",void 0),e([p()],O.prototype,\"suspended\",void 0),e([p({readOnly:!0})],O.prototype,\"fullExtentInLocalViewSpatialReference\",void 0),e([p()],O.prototype,\"updating\",void 0),O=e([y(\"esri.views.3d.layers.DynamicLayerView3D\")],O);const P=x();var V=O;export default V;\n","/*\nAll material copyright ESRI, All Rights Reserved, unless otherwise specified.\nSee https://js.arcgis.com/4.20/esri/copyright.txt for details.\n*/\nimport{_ as e}from\"../../../../chunks/tslib.es6.js\";import{bindSliceUniformsWithOrigin as t}from\"../core/shaderLibrary/Slice.glsl.js\";import{bindMultipassTerrainTexture as r}from\"../core/shaderLibrary/shading/MultipassTerrainTest.glsl.js\";import{bindProjectionMatrix as i,bindView as s}from\"../core/shaderLibrary/util/View.glsl.js\";import{ReloadableShaderModule as a}from\"../core/shaderTechnique/ReloadableShaderModule.js\";import{ShaderTechnique as o}from\"../core/shaderTechnique/ShaderTechnique.js\";import{ShaderTechniqueConfiguration as n,parameter as l}from\"../core/shaderTechnique/ShaderTechniqueConfiguration.js\";import{Default3D as p}from\"../lib/DefaultVertexAttributeLocations.js\";import{OITBlending as c,OITDepthTest as u,OITDepthWrite as d,getOITPolygonOffset as h}from\"../lib/OrderIndependentTransparency.js\";import{Program as m}from\"../lib/Program.js\";import{stencilWriteMaskOn as b,stencilToolMaskBaseParams as f,stencilBaseAllZerosParams as g}from\"../lib/StencilUtils.js\";import{I as y}from\"../../../../chunks/ImageMaterial.glsl.js\";import{makePipelineState as T,cullingParams as P,defaultDepthWriteParams as v,defaultColorWriteParams as j,simpleBlendingParams as S}from\"../../../webgl/renderState.js\";class E extends o{initializeProgram(e){const t=E.shader.get(),r=this.configuration,i=t.build({output:r.output,slicePlaneEnabled:r.slicePlaneEnabled,sliceHighlightDisabled:!1,sliceEnabledForVertexPrograms:!1,OITEnabled:0===r.transparencyPassType,multipassTerrainEnabled:r.multipassTerrainEnabled,cullAboveGround:r.cullAboveGround});return new m(e.rctx,i,p)}bindPass(e,t){i(this.program,t.camera.projectionMatrix),this.program.setUniform1f(\"opacity\",e.opacity),t.multipassTerrainEnabled&&(this.program.setUniform2fv(\"cameraNearFar\",t.camera.nearFar),this.program.setUniform2fv(\"inverseViewport\",t.inverseViewport),r(this.program,t))}bindDraw(e){s(this.program,e),t(this.program,this.configuration,e),this.program.rebindTextures()}setPipelineState(e,t){const r=this.configuration,i=3===e,s=2===e;return T({blending:0!==r.output&&7!==r.output||!r.transparent?null:i?w:c(e),culling:P(r.cullFace),depthTest:{func:u(e)},depthWrite:i?r.writeDepth&&v:d(e),colorWrite:j,stencilWrite:r.sceneHasOcludees?b:null,stencilTest:r.sceneHasOcludees?t?f:g:null,polygonOffset:i||s?null:h(r.enableOffset)})}initializePipeline(){return this._occludeePipelineState=this.setPipelineState(this.configuration.transparencyPassType,!0),this.setPipelineState(this.configuration.transparencyPassType,!1)}getPipelineState(e){return e?this._occludeePipelineState:this.pipeline}}E.shader=new a(y,(()=>import(\"./ImageMaterial.glsl.js\")));const w=S(1,771);class O extends n{constructor(){super(...arguments),this.output=0,this.cullFace=0,this.slicePlaneEnabled=!1,this.transparent=!1,this.enableOffset=!0,this.writeDepth=!0,this.sceneHasOcludees=!1,this.transparencyPassType=3,this.multipassTerrainEnabled=!1,this.cullAboveGround=!1}}e([l({count:8})],O.prototype,\"output\",void 0),e([l({count:3})],O.prototype,\"cullFace\",void 0),e([l()],O.prototype,\"slicePlaneEnabled\",void 0),e([l()],O.prototype,\"transparent\",void 0),e([l()],O.prototype,\"enableOffset\",void 0),e([l()],O.prototype,\"writeDepth\",void 0),e([l()],O.prototype,\"sceneHasOcludees\",void 0),e([l({count:4})],O.prototype,\"transparencyPassType\",void 0),e([l()],O.prototype,\"multipassTerrainEnabled\",void 0),e([l()],O.prototype,\"cullAboveGround\",void 0);export{E as ImageMaterialTechnique,O as ImageMaterialTechniqueConfiguration};\n","/*\nAll material copyright ESRI, All Rights Reserved, unless otherwise specified.\nSee https://js.arcgis.com/4.20/esri/copyright.txt for details.\n*/\nimport e from\"../lib/GLMaterialTexture.js\";import{Material as t,materialParametersDefaults as i}from\"../lib/Material.js\";import{OITPolygonOffsetLimit as s}from\"../lib/OrderIndependentTransparency.js\";import{DefaultBufferWriter as a,PositionUVLayout as r}from\"./internal/DefaultBufferWriter.js\";import{intersectTriangleGeometry as n}from\"./internal/MaterialUtil.js\";import{ImageMaterialTechniqueConfiguration as u,ImageMaterialTechnique as h}from\"../shaders/ImageMaterialTechnique.js\";class c extends t{constructor(e){super(e,p),this.supportsEdges=!0,this.techniqueConfig=new u}getTechniqueConfig(e,t){return this.techniqueConfig.output=e,this.techniqueConfig.cullFace=this.params.cullFace,this.techniqueConfig.slicePlaneEnabled=this.params.slicePlaneEnabled,this.techniqueConfig.transparent=this.params.transparent,this.techniqueConfig.writeDepth=this.params.writeDepth,this.techniqueConfig.sceneHasOcludees=this.params.sceneHasOcludees,this.techniqueConfig.transparencyPassType=t?t.transparencyPassType:3,this.techniqueConfig.enableOffset=!t||t.camera.relativeElevation<s,this.techniqueConfig.multipassTerrainEnabled=!!t&&t.multipassTerrainEnabled,this.techniqueConfig.cullAboveGround=!!t&&t.cullAboveGround,this.techniqueConfig}intersect(e,t,i,s,a,r,u){n(e,t,s,a,r,void 0,u)}getGLMaterial(e){return 0===e.output||7===e.output||4===e.output?new l(e):void 0}createBufferWriter(){return new a(r)}}class l extends e{constructor(e){super({...e,...e.material.params}),this.updateParameters()}updateParameters(e){const t=this._material.params;this.updateTexture(t.textureId),this._technique=this._techniqueRep.releaseAndAcquire(h,this._material.getTechniqueConfig(this._output,e),this._technique)}beginSlot(e){if(4===this._output)return 3===e;return e===(this._technique.configuration.transparent?this._technique.configuration.writeDepth?5:8:3)}_updateOccludeeState(e){e.hasOccludees!==this._material.params.sceneHasOcludees&&(this._material.setParameterValues({sceneHasOcludees:e.hasOccludees}),this.updateParameters(e))}ensureParameters(e){0!==this._output&&7!==this._output||this._updateOccludeeState(e),this.updateParameters(e)}bind(e){this.bindTextures(this._technique.program),this.bindTextureScale(this._technique.program),this._technique.bindPass(this._material.params,e)}getPipelineState(e,t){return this._technique.getPipelineState(t)}}const p={transparent:!1,writeDepth:!0,slicePlaneEnabled:!1,cullFace:0,sceneHasOcludees:!1,opacity:1,textureId:null,initTextureTransparent:!0,...i};export{c as ImageMaterial};\n"],"sourceRoot":""}